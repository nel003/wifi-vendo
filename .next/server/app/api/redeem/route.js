(()=>{var e={};e.id=354,e.ids=[354],e.modules={28303:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=28303,e.exports=t},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{"use strict";e.exports=require("buffer")},79646:e=>{"use strict";e.exports=require("child_process")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},29021:e=>{"use strict";e.exports=require("fs")},91645:e=>{"use strict";e.exports=require("net")},19771:e=>{"use strict";e.exports=require("process")},27910:e=>{"use strict";e.exports=require("stream")},41204:e=>{"use strict";e.exports=require("string_decoder")},66136:e=>{"use strict";e.exports=require("timers")},34631:e=>{"use strict";e.exports=require("tls")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},47422:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>d,serverHooks:()=>f,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>E});var s={};r.r(s),r.d(s,{POST:()=>m});var a=r(42706),i=r(28203),o=r(45994),n=r(78190),u=r(26714),c=r(79646),p=r(98179),l=r.n(p);async function m(e){let t=await u.A.getConnection();try{let{voucher:r}=await e.json(),s=e.headers.get("x-forwarded-for")?.replace("::ffff:","").split(",").shift(),a=await (0,n.g)(s);if(!a.mac||""===a.mac.trim()||!s)return new Response("No MAC address found",{status:404});await t.beginTransaction();let[i]=await u.A.execute("SELECT * FROM clients WHERE mac = ?;",[a.mac]),o=l().tz(i[0].last_attempt,"Asia/Manila"),p=l().tz("Asia/Manila").startOf("day");if(o.isSame(p,"day")&&i[0].attempts>=5)return Response.json({msg:"Too many attempts, try again tomorrow!"},{status:400});let[m]=await u.A.execute("SELECT * FROM vouchers WHERE voucher = ? AND used = 0;",[r]);if(0==m.length)return await t.execute("UPDATE clients SET attempts = attempts + 1, last_attempt = NOW() WHERE mac = ?;",[a.mac]),Response.json({msg:"Voucher not found or Expired"},{status:404});o.isSame(p,"day")||await t.execute("UPDATE clients SET attempts = 0, last_attempt = NOW() WHERE mac = ?;",[a.mac]),await t.execute(`
            UPDATE clients
            SET paused = 0, can_pause = 1, expire_on = IF(expire_on > NOW(), DATE_ADD(expire_on, INTERVAL ? MINUTE), DATE_ADD(NOW(), INTERVAL ? MINUTE))
            WHERE mac = ?`,[m[0].time,m[0].time,a.mac]),await t.execute("UPDATE vouchers SET used = 1 WHERE voucher = ?;",[r]),await t.commit();let[d]=await u.A.execute("SELECT * FROM clients WHERE mac = ?;",[a.mac]),x=l()(d[0].expire_on).diff(l()(),"seconds");return(0,c.execSync)(`ipset add allowed_macs ${a.mac} timeout ${x>=2147483?2147483:x} -exist`),Response.json({msg:"success",user:{...d[0],timeout:x}},{status:200})}catch(e){return console.log(e),await t.rollback(),Response.json({msg:"Something went wrong!"},{status:500})}finally{t.release()}}let d=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/redeem/route",pathname:"/api/redeem",filename:"route",bundlePath:"app/api/redeem/route"},resolvedPagePath:"C:\\Users\\bispl\\OneDrive\\Desktop\\arns\\wifi-vendo\\app\\api\\redeem\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:E,serverHooks:f}=d;function w(){return(0,o.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:E})}},96487:()=>{},78335:()=>{},26714:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var s=r(60820);global._mysqlPool||(global._mysqlPool=s.createPool({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,waitForConnections:!0,connectionLimit:10,queueLimit:0}));let a=global._mysqlPool},78190:(e,t,r)=>{"use strict";r.d(t,{g:()=>a});let s=r(29021);async function a(e){return e?new Promise((t,r)=>{s.readFile("/var/lib/misc/dnsmasq.leases","utf-8",(s,a)=>{if(s)return r(`Error reading lease file: ${s.message}`);for(let r of a.split("\n")){let s=r.split(" ");if(s.length>=5&&s[2]===e)return t({mac:s[1],deviceName:"*"!==s[3]?s[3]:null})}t({mac:null,deviceName:null})})}):{mac:null,deviceName:null}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[994,505,717,179],()=>r(47422));module.exports=s})();