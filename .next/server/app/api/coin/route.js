(()=>{var e={};e.id=713,e.ids=[713],e.modules={28303:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=28303,e.exports=t},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{"use strict";e.exports=require("buffer")},79646:e=>{"use strict";e.exports=require("child_process")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},29021:e=>{"use strict";e.exports=require("fs")},91645:e=>{"use strict";e.exports=require("net")},19771:e=>{"use strict";e.exports=require("process")},27910:e=>{"use strict";e.exports=require("stream")},41204:e=>{"use strict";e.exports=require("string_decoder")},66136:e=>{"use strict";e.exports=require("timers")},34631:e=>{"use strict";e.exports=require("tls")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},18053:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>k,routeModule:()=>T,serverHooks:()=>D,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>R});var s={};r.r(s),r.d(s,{GET:()=>A,SOCKET:()=>h});var o=r(42706),i=r(28203),n=r(45994),a=r(78190),c=r(26714),l=r(14717),u=r.n(l),p=r(79646);let d=require("serialport");class f{static{this.instance=null}constructor(){}static getInstance(){return f.instance||(f.instance=new d.SerialPort({path:"/dev/ttyS1",baudRate:115200,autoOpen:!1}),f.instance.open(e=>{if(e){console.error("Error opening serial port:",e.message);return}console.log("Serial port opened."),f.instance?.write(JSON.stringify({type:"status",value:"ok"})+"\n")})),f.instance}}let m=f.getInstance(),g=null,v=null,x=0,y=0,E=!1,S=!1,N=+(process.env.TIMEOUT||"0"),O=!1;function q(){g=null,clearInterval(v),v=null,y=0,E=!1}async function w(e,t){let r=y;if(S){setTimeout(()=>{w(e,g||"")},x+500);return}console.log("MAC: ",t);let s=0;if(e.clients.forEach(e=>{e.send(JSON.stringify({from:"coinslot",for:g,value:"isClose"}))}),m.write(JSON.stringify({type:"cmd",secret:"secret",value:"close"})+"\n"),y>0&&g?.trim()!=""){let[e]=await c.A.query("SELECT * FROM rates ORDER BY price DESC");for(let t of(console.log(e),e)){let e=Number(t.price);if(isNaN(e)||e<=0){console.log("Skipping invalid rate:",t);continue}if(y<e)continue;let r=Math.floor(y/e);y%=e,r<1||(s+=r*t.time)}await c.A.execute(`
      UPDATE clients
      SET paused = 0, can_pause = 1, expire_on = IF(expire_on > NOW(), DATE_ADD(expire_on, INTERVAL ? MINUTE), DATE_ADD(NOW(), INTERVAL ? MINUTE))
      WHERE mac = ?`,[1*s,1*s,t]),await c.A.execute(`
      INSERT INTO transactions VALUES(0, ?, ?)`,[r,t]);let[o]=await c.A.execute("SELECT * FROM clients WHERE mac = ?;",[t]),i=u()(o[0].expire_on).diff(u()(),"seconds");(0,p.execSync)(`ipset add allowed_macs ${t} timeout ${i>=2147483?2147483:i} -exist`)}q()}function A(){let e=new Headers;return e.set("Connection","Upgrade"),e.set("Upgrade","websocket"),new Response("Upgrade Required",{status:426,headers:e})}async function h(e,t,r){let s=t.headers["x-forwarded-for"]?.toString()||t.socket.remoteAddress,o=s?.replace("::ffff:","").split(",").shift(),i=await (0,a.g)(o);console.log("A client connected"),console.log(o),m&&!O&&(O=!0,m.on("data",e=>{try{let t=JSON.parse(e.toString());"init"==t.type&&m.write(JSON.stringify({type:"status",value:"ok"})+"\n"),"notify"==t.type&&(S=!0,x=1e3*N,r.clients.forEach(e=>{e.send(JSON.stringify({from:"notify",for:g,value:"ok"}))}),m.write(JSON.stringify({type:"status",value:"ok"})+"\n")),"res"==t.type&&(r.clients.forEach(e=>{e.send(JSON.stringify({from:"coinslot",for:g,value:"open"==t.value?"isOpen":"isClose"}))}),E="open"==t.value),"coin"==t.type&&(S=!1,y+=+t.value,setTimeout(()=>{r.clients.forEach(e=>{e.send(JSON.stringify({from:"totalcoin",value:y,for:g}))})},700)),console.log(t),console.log(y)}catch(e){console.log(e)}})),e.on("message",t=>{let s=JSON.parse(t.toString());"user"==s.from&&(i.mac&&""!==i.mac.trim()&&o||e.close(),console.log(o),i.mac&&"start"==s.value&&(v&&g?e.send(JSON.stringify({from:"server",value:"inuse"})):(g=i.mac,m.write(JSON.stringify({type:"cmd",value:"open"})+"\n"),x=1e3*N,v=setInterval(()=>{E||q(),e.send(JSON.stringify({from:"timer",for:g,timeleft:x/(1e3*N)*100-10})),x<=0&&w(r,g||""),console.log(x-=1e3)},1e3))),"stop"==s.value&&v&&g==i.mac&&w(r,g||"")),console.log("Received message:",s)}),e.on("close",()=>{i.mac&&i.mac===g&&w(r,g||"")})}let T=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/coin/route",pathname:"/api/coin",filename:"route",bundlePath:"app/api/coin/route"},resolvedPagePath:"/root/wifi-vendo/app/api/coin/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:_,workUnitAsyncStorage:R,serverHooks:D}=T;function k(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:R})}},96487:()=>{},78335:()=>{},26714:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var s=r(60820);global._mysqlPool||(global._mysqlPool=s.createPool({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME,waitForConnections:!0,connectionLimit:10,queueLimit:0}));let o=global._mysqlPool},78190:(e,t,r)=>{"use strict";r.d(t,{g:()=>o});let s=r(29021);async function o(e){return e?new Promise((t,r)=>{s.readFile("/var/lib/misc/dnsmasq.leases","utf-8",(s,o)=>{if(s)return r(`Error reading lease file: ${s.message}`);for(let r of o.split("\n")){let s=r.split(" ");if(s.length>=5&&s[2]===e)return t({mac:s[1],deviceName:"*"!==s[3]?s[3]:null})}t({mac:null,deviceName:null})})}):{mac:null,deviceName:null}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[994,505,717],()=>r(18053));module.exports=s})();